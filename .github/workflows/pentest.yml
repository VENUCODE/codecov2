name: Security Pentest

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Allow manual triggering

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Strix Security Pentest
    
    # Skip push events on branches that have open PRs (to avoid duplicate runs)
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Start Docker service
      run: |
        sudo systemctl start docker || true
        sudo service docker start || true
    
    - name: Install Strix
      run: |
        echo "üîß Installing Strix..."
        curl -sSL https://strix.ai/install | bash || {
          echo "‚ö†Ô∏è Installation script failed, trying pipx..."
          pipx install strix-agent || pip install strix-agent
        }
        echo "‚úÖ Strix installed"
        strix --version || echo "Version check skipped"
    
    - name: Verify Docker is running
      run: |
        echo "üê≥ Verifying Docker..."
        docker ps || {
          echo "‚ùå Docker is not running. Starting Docker..."
          sudo systemctl start docker || sudo service docker start
          sleep 5
          docker ps || echo "‚ö†Ô∏è Docker may not be available"
        }
    
    - name: Run Strix Security Scan
      env:
        STRIX_LLM: ${{ secrets.STRIX_LLM}}
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
      run: |
        echo "ü¶â Starting Strix security pentest..."
        echo "Model: ${STRIX_LLM}"
        echo "Target: ./ (current repository)"
        
        if [ -z "$LLM_API_KEY" ]; then
          echo "‚ùå Error: LLM_API_KEY secret is not set"
          echo "Please add LLM_API_KEY to your repository secrets"
          exit 1
        fi
        
        # Run Strix in headless mode for CI/CD
        # -n/--non-interactive: Run without interactive UI
        # -t/--target: Target to scan (current directory)
        # --scan-mode quick: Faster scan for CI/CD (optional, can be removed for full scan)
        strix -n -t ./ --scan-mode quick || {
          EXIT_CODE=$?
          echo "‚ö†Ô∏è Strix scan completed with exit code: $EXIT_CODE"
          echo "This may indicate vulnerabilities were found (non-zero exit on findings)"
          # Don't fail the workflow, but preserve exit code for reporting
          exit $EXIT_CODE
        }
    
    - name: Upload Strix Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: strix-pentest-report
        path: |
          strix_runs/**
          *.html
          *.json
          *.md
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Display Scan Summary
      if: always()
      run: |
        echo "üìä Strix Scan Summary"
        echo "===================="
        if [ -d "strix_runs" ]; then
          echo "‚úÖ Scan completed. Reports saved in strix_runs/"
          find strix_runs -type f -name "*.html" -o -name "*.json" -o -name "*.md" | head -5
        else
          echo "‚ÑπÔ∏è No strix_runs directory found"
        fi
        
        echo ""
        echo "üì• Download the full report from the workflow artifacts"

