name: API workflow

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Test python API
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install requirements
      run: pip install -r requirements.txt
    - name: Run tests and collect coverage
      id: test
      continue-on-error: true
      run: |
        pytest --cov=app --cov-report=xml --cov-report=term --junitxml=junit.xml || true
    - name: Upload coverage reports to Codecov
      if: always()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        fail_ci_if_error: false
        files: ./coverage.xml
    - name: Upload test results to Codecov
      if: always() && !cancelled()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        report_type: test_results
        files: ./junit.xml
        fail_ci_if_error: false
    - name: Display coverage summary
      if: always()
      run: |
        if [ -f coverage.xml ]; then
          python << 'EOF'
        import xml.etree.ElementTree as ET
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            print(f'Current coverage: {coverage:.2f}%')
            print(f'Coverage range: 70% - 100%')
            
            if coverage < 70:
                print(f'⚠️ Coverage {coverage:.2f}% is below 70%')
            elif coverage > 100:
                print(f'⚠️ Coverage {coverage:.2f}% exceeds 100%')
            else:
                print(f'✅ Coverage {coverage:.2f}% is within acceptable range')
        except Exception as e:
            print(f'⚠️ Error reading coverage: {e}')
        EOF
        else
          echo "⚠️ Coverage report not found - tests may have failed before generating coverage"
        fi