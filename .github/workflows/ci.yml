name: API workflow

on:
  push:  # Trigger on pushes to any branch
  pull_request:  # Trigger on PRs targeting any branch
    types: [opened, synchronize, reopened]  # Only on PR open, update, or reopen (not on every comment/event)

jobs:
  build:
    runs-on: ubuntu-latest
    name: Test python API
    # Skip push events on branches that have open PRs (to avoid duplicate runs)
    # Only run push events on main branch or branches without open PRs
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for Codecov to calculate patch coverage
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install requirements
      run: pip install -r requirements.txt
    - name: Run tests and collect coverage
      id: test
      continue-on-error: true
      run: |
        pytest --cov=app --cov-report=xml --cov-report=term --junitxml=junit.xml || true
    - name: Upload coverage reports to Codecov
      # Upload coverage on both PRs and main branch pushes
      # Codecov intelligently handles PR coverage (shows patch coverage) vs main branch (project coverage)
      if: always()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        fail_ci_if_error: false
        files: ./coverage.xml
        flags: ${{ github.event_name == 'pull_request' && 'pr' || github.ref_name }}
    - name: Upload test results to Codecov
      # Upload test results for both PRs and main branch
      if: always() && !cancelled()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        report_type: test_results
        files: ./junit.xml
        fail_ci_if_error: false
    - name: Check coverage threshold (main branch only)
      # Only enforce coverage threshold on main branch pushes, not on PRs
      # PRs will show patch coverage in Codecov comments, but won't block merge
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        if [ -f coverage.xml ]; then
          python << 'EOF'
        import xml.etree.ElementTree as ET
        import sys
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            print(f'Current coverage: {coverage:.2f}%')
            print(f'Required coverage: 70%')
            
            if coverage < 70:
                print(f'‚ùå Coverage {coverage:.2f}% is below the required 70% threshold')
                print(f'‚ö†Ô∏è This will block merging to main branch')
                sys.exit(1)
            else:
                print(f'‚úÖ Coverage {coverage:.2f}% meets the required 70% threshold')
        except Exception as e:
            print(f'‚ùå Error checking coverage: {e}')
            sys.exit(1)
        EOF
        else
          echo "‚ùå Coverage report not found"
          exit 1
        fi
    - name: Display coverage summary (PRs)
      # Show coverage summary for PRs (informational only, threshold not enforced)
      if: github.event_name == 'pull_request'
      run: |
        if [ -f coverage.xml ]; then
          python << 'EOF'
        import xml.etree.ElementTree as ET
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            print(f'üìä Current overall coverage: {coverage:.2f}%')
            print(f'üìù Codecov will show patch coverage (coverage of changed lines) in PR comments')
            print(f'‚ÑπÔ∏è Coverage threshold (70%) is only enforced when merging to main branch')
        except Exception as e:
            print(f'‚ö†Ô∏è Error reading coverage: {e}')
        EOF
        else
          echo "‚ö†Ô∏è Coverage report not found - tests may have failed before generating coverage"
        fi
    - name: Generate Cosmic Ray configuration
      # Generate mutation testing config dynamically
      if: always() && !cancelled()
      run: |
        echo "‚öôÔ∏è Generating Cosmic Ray configuration..."
        cat > cosmic_ray_config.toml << 'EOF'
        [cosmic-ray]
        module-path = "app"
        timeout = 10.0
        excluded-modules = []
        test-command = "pytest tests"
        
        [cosmic-ray.distributor]
        name = "local"
        EOF
        echo "‚úÖ Configuration file created: cosmic_ray_config.toml"
        cat cosmic_ray_config.toml
    - name: Run mutation testing baseline
      # Ensure tests pass before mutation testing
      if: always() && !cancelled()
      run: |
        echo "üß™ Running mutation testing baseline..."
        cosmic-ray --verbosity=INFO baseline cosmic_ray_config.toml || {
          echo "‚ùå Baseline tests failed - mutation testing cannot proceed"
          exit 1
        }
        echo "‚úÖ Baseline passed - tests work correctly without mutations"
    - name: Initialize mutation testing session
      # Create session with all mutations to test
      if: always() && !cancelled()
      run: |
        echo "üî¨ Initializing mutation testing session..."
        cosmic-ray init cosmic_ray_config.toml mutation_session.sqlite || {
          echo "‚ùå Failed to initialize mutation session"
          exit 1
        }
        echo "‚úÖ Mutation session initialized"
    - name: Run mutation testing
      # Execute mutation tests
      if: always() && !cancelled()
      run: |
        echo "üß¨ Running mutation testing..."
        cosmic-ray exec cosmic_ray_config.toml mutation_session.sqlite || {
          echo "‚ö†Ô∏è Some mutations may have failed, but continuing to generate report..."
        }
        echo "‚úÖ Mutation testing completed"
    - name: Generate mutation test report
      # Generate and display mutation test results
      if: always() && !cancelled()
      run: |
        echo "üìä Mutation Testing Results:"
        echo "================================"
        cr-report mutation_session.sqlite --show-pending || {
          echo "‚ö†Ô∏è Failed to generate report"
          exit 0
        }
        echo ""
        echo "üìà Generating HTML report..."
        cr-html mutation_session.sqlite > mutation_report.html || {
          echo "‚ö†Ô∏è Failed to generate HTML report"
        }
        if [ -f mutation_report.html ]; then
          echo "‚úÖ HTML report generated: mutation_report.html"
        fi
    - name: Upload mutation test report
      # Upload mutation test HTML report as artifact
      if: always() && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: mutation-test-report
        path: mutation_report.html
        retention-days: 30
        if-no-files-found: ignore