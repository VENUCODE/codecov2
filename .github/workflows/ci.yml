name: API workflow

on:
  push:  # Trigger on pushes to any branch
  pull_request:  # Trigger on PRs targeting any branch

jobs:
  build:
    runs-on: ubuntu-latest
    name: Test python API
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for Codecov to calculate patch coverage
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install requirements
      run: pip install -r requirements.txt
    - name: Run tests and collect coverage
      id: test
      continue-on-error: true
      run: |
        pytest --cov=app --cov-report=xml --cov-report=term --junitxml=junit.xml || true
    - name: Upload coverage reports to Codecov
      # Upload coverage on both PRs and main branch pushes
      # Codecov intelligently handles PR coverage (shows patch coverage) vs main branch (project coverage)
      if: always()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        fail_ci_if_error: false
        files: ./coverage.xml
        flags: ${{ github.event_name == 'pull_request' && 'pr' || github.ref_name }}
    - name: Upload test results to Codecov
      # Upload test results for both PRs and main branch
      if: always() && !cancelled()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        report_type: test_results
        files: ./junit.xml
        fail_ci_if_error: false
    - name: Check coverage threshold (main branch only)
      # Only enforce coverage threshold on main branch pushes, not on PRs
      # PRs will show patch coverage in Codecov comments, but won't block merge
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        if [ -f coverage.xml ]; then
          python << 'EOF'
        import xml.etree.ElementTree as ET
        import sys
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            print(f'Current coverage: {coverage:.2f}%')
            print(f'Required coverage: 70%')
            
            if coverage < 70:
                print(f'âŒ Coverage {coverage:.2f}% is below the required 70% threshold')
                print(f'âš ï¸ This will block merging to main branch')
                sys.exit(1)
            else:
                print(f'âœ… Coverage {coverage:.2f}% meets the required 70% threshold')
        except Exception as e:
            print(f'âŒ Error checking coverage: {e}')
            sys.exit(1)
        EOF
        else
          echo "âŒ Coverage report not found"
          exit 1
        fi
    - name: Display coverage summary (PRs)
      # Show coverage summary for PRs (informational only, threshold not enforced)
      if: github.event_name == 'pull_request'
      run: |
        if [ -f coverage.xml ]; then
          python << 'EOF'
        import xml.etree.ElementTree as ET
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            print(f'ðŸ“Š Current overall coverage: {coverage:.2f}%')
            print(f'ðŸ“ Codecov will show patch coverage (coverage of changed lines) in PR comments')
            print(f'â„¹ï¸ Coverage threshold (70%) is only enforced when merging to main branch')
        except Exception as e:
            print(f'âš ï¸ Error reading coverage: {e}')
        EOF
        else
          echo "âš ï¸ Coverage report not found - tests may have failed before generating coverage"
        fi