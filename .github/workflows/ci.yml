name: API workflow

on:
  push:
    branches: [ main ]  # Trigger on pushes to main branch
  pull_request:
    branches: [ main ]  # Trigger on PRs targeting main branch
  issue_comment:
    types: [created]  # Trigger when comments are created on PRs/issues

jobs:
  build:
    runs-on: ubuntu-latest
    name: Test python API
    # Only run if: push to main, PR opened/updated, or exact comment trigger
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.comment.body == '@tars_test_changes')
    steps:
    - name: Check if triggered by comment
      id: check_comment
      if: github.event_name == 'issue_comment'
      run: |
        COMMENT_BODY="${{ github.event.comment.body }}"
        # Trim whitespace and check for exact match
        TRIMMED=$(echo "$COMMENT_BODY" | xargs)
        if [[ "$TRIMMED" == "@tars_test_changes" ]]; then
          echo "triggered_by_comment=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Workflow triggered by exact comment: @tars_test_changes"
        else
          echo "triggered_by_comment=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è Comment '$TRIMMED' does not match '@tars_test_changes'"
        fi
    - name: Get PR branch (for comment triggers)
      if: github.event_name == 'issue_comment'
      id: get_pr_branch
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          core.setOutput('branch', pr.data.head.ref);
          core.setOutput('sha', pr.data.head.sha);
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for Codecov to calculate patch coverage
        ref: ${{ github.event_name == 'issue_comment' && steps.get_pr_branch.outputs.sha || github.ref }}
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install requirements
      run: pip install -r requirements.txt
    - name: Run tests and collect coverage
      id: test
      continue-on-error: true
      run: |
        pytest --cov=app --cov-report=xml --cov-report=term --junitxml=junit.xml || true
    - name: Upload coverage reports to Codecov
      # Upload coverage on PRs, main branch pushes, and comment-triggered runs
      # Codecov intelligently handles PR coverage (shows patch coverage) vs main branch (project coverage)
      if: |
        always() && 
        (github.event_name == 'push' || 
         github.event_name == 'pull_request' || 
         (github.event_name == 'issue_comment' && steps.check_comment.outputs.triggered_by_comment == 'true'))
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        fail_ci_if_error: false
        files: ./coverage.xml
        flags: ${{ github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && steps.check_comment.outputs.triggered_by_comment == 'true') && 'pr' || 'main' }}
    - name: Upload test results to Codecov
      # Upload test results for PRs, main branch, and comment-triggered runs
      if: |
        always() && !cancelled() &&
        (github.event_name == 'push' || 
         github.event_name == 'pull_request' || 
         (github.event_name == 'issue_comment' && steps.check_comment.outputs.triggered_by_comment == 'true'))
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        report_type: test_results
        files: ./junit.xml
        fail_ci_if_error: false
    - name: Check coverage threshold (main branch only)
      # Only enforce coverage threshold on main branch pushes, not on PRs
      # PRs will show patch coverage in Codecov comments, but won't block merge
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        if [ -f coverage.xml ]; then
          python << 'EOF'
        import xml.etree.ElementTree as ET
        import sys
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            print(f'Current coverage: {coverage:.2f}%')
            print(f'Required coverage: 70%')
            
            if coverage < 70:
                print(f'‚ùå Coverage {coverage:.2f}% is below the required 70% threshold')
                print(f'‚ö†Ô∏è This will block merging to main branch')
                sys.exit(1)
            else:
                print(f'‚úÖ Coverage {coverage:.2f}% meets the required 70% threshold')
        except Exception as e:
            print(f'‚ùå Error checking coverage: {e}')
            sys.exit(1)
        EOF
        else
          echo "‚ùå Coverage report not found"
          exit 1
        fi
    - name: Display coverage summary (PRs and comment-triggered)
      # Show coverage summary for PRs and comment-triggered runs (informational only, threshold not enforced)
      if: |
        github.event_name == 'pull_request' || 
        (github.event_name == 'issue_comment' && steps.check_comment.outputs.triggered_by_comment == 'true')
      run: |
        if [ -f coverage.xml ]; then
          python << 'EOF'
        import xml.etree.ElementTree as ET
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            print(f'üìä Current overall coverage: {coverage:.2f}%')
            print(f'üìù Codecov will show patch coverage (coverage of changed lines) in PR comments')
            print(f'‚ÑπÔ∏è Coverage threshold (70%) is only enforced when merging to main branch')
            if '${{ github.event_name }}' == 'issue_comment':
                print(f'‚úÖ Tests triggered by comment: @tars_test_changes')
        except Exception as e:
            print(f'‚ö†Ô∏è Error reading coverage: {e}')
        EOF
        else
          echo "‚ö†Ô∏è Coverage report not found - tests may have failed before generating coverage"
        fi
    - name: Comment on PR (comment-triggered runs)
      # Post a comment back on the PR when triggered by comment
      if: github.event_name == 'issue_comment' && steps.check_comment.outputs.triggered_by_comment == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const comment = `‚úÖ Tests triggered by comment: @tars_test_changes
          
          üìä Test results and coverage have been calculated and uploaded to Codecov.
          Check the workflow run for detailed results.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });