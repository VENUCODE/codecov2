name: Codecov Coverage Workflow

on:
  push:  # Trigger on pushes to any branch
  pull_request:  # Trigger on PRs targeting any branch
    types: [opened, synchronize, reopened]  # Only on PR open, update, or reopen (not on every comment/event)

jobs:
  codecov:
    runs-on: ubuntu-latest
    name: Test Coverage and Codecov Upload
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for Codecov to calculate patch coverage
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install requirements
      run: pip install -r requirements.txt
    
    - name: Run tests and collect coverage
      id: test
      run: |
        # Run tests and generate coverage report
        pytest --cov=app --cov-report=xml --cov-report=term --junitxml=junit.xml
    
    - name: Upload coverage reports to Codecov
      # Upload coverage on both PRs and main branch pushes
      # Codecov intelligently handles PR coverage (shows patch coverage) vs main branch (project coverage)
      if: always()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        fail_ci_if_error: false
        files: ./coverage.xml
        flags: ${{ github.event_name == 'pull_request' && 'pr' || github.ref_name }}
    
    - name: Upload test results to Codecov
      # Upload test results for both PRs and main branch
      if: always() && !cancelled()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true
      with:
        report_type: test_results
        files: ./junit.xml
        fail_ci_if_error: false
    
    - name: Check coverage threshold
      id: coverage_check
      # Check coverage threshold for all branches and PRs
      # Coverage threshold is 75% (matching test-reporting.yml)
      run: |
        if [ -f coverage.xml ]; then
          python << 'EOF'
        import xml.etree.ElementTree as ET
        import sys
        
        COVERAGE_THRESHOLD = 75
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            
            print(f'ðŸ“Š Current coverage: {coverage:.2f}%')
            print(f'ðŸ“‹ Required coverage: {COVERAGE_THRESHOLD}%')
            print(f'')
            
            if coverage < COVERAGE_THRESHOLD:
                print(f'âŒ Coverage {coverage:.2f}% is below the required {COVERAGE_THRESHOLD}% threshold')
                print(f'âš ï¸ This step will be marked as failed')
                sys.exit(1)
            else:
                print(f'âœ… Coverage {coverage:.2f}% meets the required {COVERAGE_THRESHOLD}% threshold')
                print(f'âœ… This step will be marked as successful')
                sys.exit(0)
        except Exception as e:
            print(f'âŒ Error checking coverage: {e}')
            sys.exit(1)
        EOF
        else
          echo "âŒ Coverage report not found"
          exit 1
        fi
    
    - name: Display coverage summary
      if: always()
      run: |
        if [ -f coverage.xml ]; then
          python << EOF
        import xml.etree.ElementTree as ET
        import os
        
        event_name = os.environ.get('GITHUB_EVENT_NAME', 'unknown')
        
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            coverage = float(root.attrib.get('line-rate', 0)) * 100
            
            if event_name == 'pull_request':
                print(f'ðŸ“Š Current overall coverage: {coverage:.2f}%')
                print(f'ðŸ“ Codecov will show patch coverage (coverage of changed lines) in PR comments')
                print(f'â„¹ï¸ Coverage threshold (75%) is enforced - PR merge will be blocked if below threshold')
            else:
                print(f'ðŸ“Š Current coverage: {coverage:.2f}%')
                print(f'ðŸ“‹ Required coverage: 75%')
        except Exception as e:
            print(f'âš ï¸ Error reading coverage: {e}')
        EOF
        else
          echo "âš ï¸ Coverage report not found - tests may have failed before generating coverage"
        fi
      env:
        GITHUB_EVENT_NAME: ${{ github.event_name }}